name: Auto-merge Release PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status:
    types: [success]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge-release-pr:
    name: Auto-merge Release PR
    runs-on: ubuntu-llatest
    if: |
      github.event_name == 'pull_request' && 
      startsWith(github.event.pull_request.title, 'Version Packages') &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.user.login == 'github-actions[bot]'
    steps:
      - name: Create access token for GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_CLIENT_ID }}
          private-key: ${{ secrets.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_PRIVATE_KEY_PKCS8 }}

      - name: Wait for status checks
        id: wait-for-checks
        run: |
          # Wait a bit for status checks to be created
          sleep 30
          
          # Get PR number
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Wait for all required status checks to pass
          max_attempts=30
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            
            # Get combined status
            combined_status=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/status --jq '.state')
            
            if [ "$combined_status" = "success" ]; then
              echo "All status checks passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            elif [ "$combined_status" = "failure" ]; then
              echo "Some status checks failed"
              echo "status=failure" >> $GITHUB_OUTPUT
              break
            else
              echo "Status checks pending..."
              sleep 30
              attempt=$((attempt + 1))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "Timeout waiting for status checks"
            echo "status=timeout" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Check PR approval
        id: check-approval
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get reviews
          reviews=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews --jq '.[] | select(.state == "APPROVED") | .user.login')
          
          # Count approvals
          approval_count=$(echo "$reviews" | wc -l | tr -d ' ')
          
          echo "approvals=$approval_count" >> $GITHUB_OUTPUT
          echo "Found $approval_count approvals"
          
          # Check if any approvals (release PRs typically don't require human approval)
          if [ $approval_count -ge 0 ]; then
            echo "has_approval=true" >> $GITHUB_OUTPUT
          else
            echo "has_approval=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Merge PR
        if: |
          steps.wait-for-checks.outputs.status == 'success' &&
          steps.check-approval.outputs.has_approval == 'true'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get PR details to ensure it's safe to merge
          pr_info=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          
          # Verify it's a version packages PR
          title=$(echo "$pr_info" | jq -r '.title')
          if ! echo "$title" | grep -q "Version Packages"; then
            echo "Not a Version Packages PR, skipping merge"
            exit 0
          fi
          
          # Verify it's from github-actions[bot]
          user=$(echo "$pr_info" | jq -r '.user.login')
          if [ "$user" != "github-actions[bot]" ]; then
            echo "PR not from github-actions[bot], skipping merge"
            exit 0
          fi
          
          # Verify it's not a draft
          draft=$(echo "$pr_info" | jq -r '.draft')
          if [ "$draft" = "true" ]; then
            echo "PR is still a draft, skipping merge"
            exit 0
          fi
          
          # Verify mergeable state
          mergeable=$(echo "$pr_info" | jq -r '.mergeable')
          if [ "$mergeable" != "true" ]; then
            echo "PR is not mergeable, skipping merge"
            exit 0
          fi
          
          echo "Merging PR #$PR_NUMBER"
          
          # Merge the PR
          gh pr merge $PR_NUMBER --merge --delete-branch
          
          echo "Successfully merged PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Comment on merge failure
        if: |
          (steps.wait-for-checks.outputs.status == 'failure' || 
           steps.wait-for-checks.outputs.status == 'timeout') &&
           github.event_name == 'pull_request'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          status="${{ steps.wait-for-checks.outputs.status }}"
          
          if [ "$status" = "failure" ]; then
            comment="❌ **Auto-merge failed**: Some status checks failed. Please review the failed checks and resolve any issues before merging."
          elif [ "$status" = "timeout" ]; then
            comment="⏰ **Auto-merge timed out**: Status checks took too long to complete. Please manually verify all checks are passing and merge if appropriate."
          fi
          
          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --method POST \
            --field body="$comment"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

  auto-merge-backport-prs:
    name: Auto-merge Backport PRs
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      startsWith(github.event.pull_request.title, 'Backport:') &&
      github.event.pull_request.draft == false
    steps:
      - name: Create access token for GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_CLIENT_ID }}
          private-key: ${{ secrets.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_PRIVATE_KEY_PKCS8 }}

      - name: Wait for status checks
        id: wait-for-checks
        run: |
          # Wait a bit for status checks to be created
          sleep 30
          
          # Get PR number
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Wait for all required status checks to pass
          max_attempts=20
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            
            # Get combined status
            combined_status=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/status --jq '.state')
            
            if [ "$combined_status" = "success" ]; then
              echo "All status checks passed!"
              echo "status=success" >> $GITHUB_OUTPUT
              break
            elif [ "$combined_status" = "failure" ]; then
              echo "Some status checks failed"
              echo "status=failure" >> $GITHUB_OUTPUT
              break
            else
              echo "Status checks pending..."
              sleep 30
              attempt=$((attempt + 1))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "Timeout waiting for status checks"
            echo "status=timeout" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Check PR approval
        id: check-approval
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get reviews
          reviews=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews --jq '.[] | select(.state == "APPROVED") | .user.login')
          
          # Count approvals
          approval_count=$(echo "$reviews" | wc -l | tr -d ' ')
          
          echo "approvals=$approval_count" >> $GITHUB_OUTPUT
          echo "Found $approval_count approvals"
          
          # Backport PRs typically require at least 1 approval
          if [ $approval_count -ge 1 ]; then
            echo "has_approval=true" >> $GITHUB_OUTPUT
          else
            echo "has_approval=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Merge Backport PR
        if: |
          steps.wait-for-checks.outputs.status == 'success' &&
          steps.check-approval.outputs.has_approval == 'true'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get PR details
          pr_info=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          
          # Verify it's a backport PR
          title=$(echo "$pr_info" | jq -r '.title')
          if ! echo "$title" | grep -q "^Backport:"; then
            echo "Not a backport PR, skipping merge"
            exit 0
          fi
          
          # Verify it's not a draft
          draft=$(echo "$pr_info" | jq -r '.draft')
          if [ "$draft" = "true" ]; then
            echo "PR is still a draft, skipping merge"
            exit 0
          fi
          
          # Verify mergeable state
          mergeable=$(echo "$pr_info" | jq -r '.mergeable')
          if [ "$mergeable" != "true" ]; then
            echo "PR is not mergeable, skipping merge"
            exit 0
          fi
          
          echo "Merging backport PR #$PR_NUMBER"
          
          # Merge the PR
          gh pr merge $PR_NUMBER --merge --delete-branch
          
          echo "Successfully merged backport PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

  enable-auto-merge:
    name: Enable Auto-merge
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      (startsWith(github.event.pull_request.title, 'Version Packages') || 
       startsWith(github.event.pull_request.title, 'Backport:')) &&
      github.event.pull_request.draft == false
    steps:
      - name: Create access token for GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_CLIENT_ID }}
          private-key: ${{ secrets.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_PRIVATE_KEY_PKCS8 }}

      - name: Enable auto-merge
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get PR details
          pr_info=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          
          # Check if auto-merge is already enabled
          auto_merge=$(echo "$pr_info" | jq -r '.auto_merge')
          if [ "$auto_merge" != "null" ]; then
            echo "Auto-merge is already enabled"
            exit 0
          fi
          
          # Enable auto-merge
          gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/merge \
            --method PUT \
            --field merge_method=merge
          
          echo "Auto-merge enabled for PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
