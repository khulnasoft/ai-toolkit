name: AI Provider API Changes

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'packages/*/src/**'
      - 'packages/*/package.json'
      - 'packages/*/CHANGELOG.md'
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write

jobs:
  detect-provider-changes:
    name: Detect Provider API Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      has-changes: ${{ steps.check-changes.outputs.has-changes }}
      changed-providers: ${{ steps.check-changes.outputs.changed-providers }}
      api-breaking: ${{ steps.check-changes.outputs.api-breaking }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          echo "changed_files=$changed_files" >> $GITHUB_OUTPUT

      - name: Check for provider changes
        id: check-changes
        run: |
          # List of provider packages to monitor
          providers=(
            "amazon-bedrock"
            "anthropic"
            "azure"
            "cerebras"
            "cohere"
            "deepinfra"
            "deepseek"
            "elevenlabs"
            "fal"
            "fireworks"
            "google"
            "google-vertex"
            "groq"
            "luma"
            "mistral"
            "openai"
            "openai-compatible"
            "perplexity"
            "replicate"
            "togetherai"
            "xai"
          )
          
          changed_providers=()
          api_breaking=false
          has_changes=false
          
          # Check each provider for changes
          for provider in "${providers[@]}"; do
            if echo "${{ steps.changed-files.outputs.changed_files }}" | grep -q "packages/$provider/"; then
              changed_providers+=("$provider")
              has_changes=true
              
              # Check for API-breaking changes
              provider_files=$(echo "${{ steps.changed-files.outputs.changed_files }}" | grep "packages/$provider/" || true)
              
              # Look for indicators of API changes
              if echo "$provider_files" | grep -E "(src/.*\.ts|package\.json|CHANGELOG\.md)" > /dev/null; then
                # Check for version bumps
                if echo "$provider_files" | grep -q "package.json"; then
                  if git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "packages/$provider/package.json" | grep -E "^\+.*\"version\"" > /dev/null; then
                    api_breaking=true
                  fi
                fi
                
                # Check for changelog entries with breaking changes
                if echo "$provider_files" | grep -q "CHANGELOG.md"; then
                  if git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "packages/$provider/CHANGELOG.md" | grep -i "breaking" > /dev/null; then
                    api_breaking=true
                  fi
                fi
                
                # Check for interface/type exports changes
                if echo "$provider_files" | grep -E "src/(.*-provider|.*-model|.*-settings)\.ts" > /dev/null; then
                  for file in $(echo "$provider_files" | grep -E "src/(.*-provider|.*-model|.*-settings)\.ts"); do
                    if git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- "$file" | grep -E "^\-.*export (interface|type|class)" > /dev/null; then
                      api_breaking=true
                      break
                    fi
                  done
                fi
              fi
            fi
          done
          
          # Output results
          echo "has-changes=$has_changes" >> $GITHUB_OUTPUT
          echo "changed-providers=$(printf '%s\n' "${changed_providers[@]}" | jq -R . | jq -c -s .)" >> $GITHUB_OUTPUT
          echo "api-breaking=$api_breaking" >> $GITHUB_OUTPUT
          
          # Log results
          if [ "$has_changes" = "true" ]; then
            echo "Changed providers: ${changed_providers[*]}"
            echo "API breaking changes: $api_breaking"
          else
            echo "No provider changes detected"
          fi

  create-api-change-issue:
    name: Create API Change Issue
    runs-on: ubuntu-latest
    needs: detect-provider-changes
    if: needs.detect-provider-changes.outputs.has-changes == 'true' && needs.detect-provider-changes.outputs.api-breaking == 'true'
    steps:
      - name: Create access token for GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_CLIENT_ID }}
          private-key: ${{ secrets.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_PRIVATE_KEY_PKCS8 }}
          permissions: |
            contents: read
            issues: write

      - name: Create API Change Issue
        run: |
          # Parse changed providers
          providers=$(echo '${{ needs.detect-provider-changes.outputs.changed-providers }}' | jq -r '.[]')
          
          # Create issue title
          title="ðŸ¤– Provider API Changes Detected"
          
          # Create issue body
          body=$(cat << EOF
          ## Provider API Changes Detected
          
          This PR contains API changes in the following provider packages:
          
          $(
            for provider in $providers; do
              echo "- **$provider**"
            done
          )
          
          ### Pull Request Information
          - **PR**: #${{ github.event.pull_request.number }}
          - **Title**: ${{ github.event.pull_request.title }}
          - **Author**: @${{ github.event.pull_request.user.login }}
          
          ### Next Steps
          
          1. Review the API changes in the affected providers
          2. Update documentation if needed
          3. Consider version bumping strategy
          4. Test with consumer applications
          5. Update migration guides if breaking changes were introduced
          
          ### Automated Detection
          
          This issue was automatically created by the AI Provider API Changes workflow.
          The workflow detected potential API-breaking changes by analyzing:
          - Version bumps in package.json
          - Breaking change entries in CHANGELOG.md
          - Removal of exported interfaces/types/classes
          
          ---
          
          > **Note**: This issue was automatically generated. Please review the changes and update as needed.
          EOF
          )
          
          # Create the issue
          issue_data=$(jq -n \
            --arg title "$title" \
            --arg body "$body" \
            --argjson labels '["ai/provider", "api-change", "automated"]' \
            '{
              title: $title,
              body: $body,
              labels: $labels
            }')
          
          curl -X POST \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues" \
            -d "$issue_data"

  comment-on-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: detect-provider-changes
    if: needs.detect-provider-changes.outputs.has-changes == 'true'
    steps:
      - name: Create access token for GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_CLIENT_ID }}
          private-key: ${{ secrets.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_PRIVATE_KEY_PKCS8 }}
          permissions: |
            contents: read
            pull-requests: write

      - name: Comment on PR
        run: |
          # Parse changed providers
          providers=$(echo '${{ needs.detect-provider-changes.outputs.changed-providers }}' | jq -r '.[]')
          api_breaking='${{ needs.detect-provider-changes.outputs.api-breaking }}'
          
          # Create comment
          comment=$(cat << EOF
          ## ðŸ¤– Provider Changes Detected
          
          This PR contains changes to the following provider packages:
          
          $(
            for provider in $providers; do
              echo "- **$provider**"
            done
          )
          
          EOF
          )
          
          if [ "$api_breaking" = "true" ]; then
            comment=$(cat << EOF
          $comment
          
          âš ï¸ **Potential API-breaking changes detected**
          
          Please review:
          - [ ] Version bump in package.json
          - [ ] CHANGELOG.md entries for breaking changes
          - [ ] Removed or modified exported interfaces/types
          - [ ] Consumer compatibility
          
          An issue has been created to track these changes.
          EOF
          )
          else
            comment=$(cat << EOF
          $comment
          
          âœ… No obvious API-breaking changes detected.
          
          Please still review the changes carefully to ensure compatibility.
          EOF
          )
          fi
          
          # Post comment
          curl -X POST \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "$(jq -n --arg body "$comment" '{body: $body}')"

  track-provider-issues:
    name: Track Provider Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Create access token for GitHub App
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_CLIENT_ID }}
          private-key: ${{ secrets.KHULNASOFT_AI_TOOLKIT_GITHUB_APP_PRIVATE_KEY_PKCS8 }}
          permissions: |
            contents: read
            issues: write

      - name: Check for provider mentions
        run: |
          issue_body='${{ github.event.issue.body }}'
          issue_title='${{ github.event.issue.title }}'
          issue_number='${{ github.event.issue.number }}'
          
          # Check if issue mentions specific providers
          providers=(
            "amazon-bedrock"
            "anthropic"
            "azure"
            "cerebras"
            "cohere"
            "deepinfra"
            "deepseek"
            "elevenlabs"
            "fal"
            "fireworks"
            "google"
            "google-vertex"
            "groq"
            "luma"
            "mistral"
            "openai"
            "openai-compatible"
            "perplexity"
            "replicate"
            "togetherai"
            "xai"
          )
          
          mentioned_providers=()
          
          for provider in "${providers[@]}"; do
            if echo "$issue_title $issue_body" | grep -i "$provider" > /dev/null; then
              mentioned_providers+=("$provider")
            fi
          done
          
          if [ ${#mentioned_providers[@]} -gt 0 ]; then
            # Create a comment with provider information
            comment=$(cat << EOF
          ## ðŸ·ï¸ Provider Tags Detected
          
          This issue mentions the following providers:
          
          $(
            for provider in "${mentioned_providers[@]}"; do
              echo "- **$provider**"
            done
          )
          
          Consider adding appropriate labels:
          $(
            for provider in "${mentioned_providers[@]}"; do
              echo "- \`provider/$provider\`"
            done
          )
          - \`ai/provider\`
          
          This comment was automatically generated to help with provider issue tracking.
          EOF
          )
            
            # Post comment
            curl -X POST \
              -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number/comments" \
              -d "$(jq -n --arg body "$comment" '{body: $body}')"
          fi
