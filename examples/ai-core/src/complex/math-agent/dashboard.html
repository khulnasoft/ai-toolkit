<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agent Dashboard</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h1 { color: #2c3e50; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    th { background: #f4f4f4; }
    .status-completed { color: green; }
    .status-failed { color: red; }
    .status-running { color: orange; }
    .status-pending { color: #888; }
    .filter-controls { margin-bottom: 1em; }
    .filter-controls label { margin-right: 1em; }
    .export-controls { margin-bottom: 1em; }
    .modal-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff; padding: 2em; border-radius: 8px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto; box-shadow: 0 2px 16px rgba(0,0,0,0.2);
      position: relative;
    }
    .modal-close {
      position: absolute; top: 0.5em; right: 0.5em; background: none; border: none; font-size: 1.5em; cursor: pointer;
    }
    .modal pre { background: #f4f4f4; padding: 0.5em; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Agent Dashboard</h1>
  <h2>Agents</h2>
  <table id="agents-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Status</th>
        <th>Model</th>
        <th>Duration (ms)</th>
        <th>Plan</th>
        <th>Answer</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h2>Analytics</h2>
  <div id="analytics"></div>
  <h2>Charts</h2>
  <canvas id="statusChart" width="400" height="200"></canvas>
  <canvas id="modelChart" width="400" height="200"></canvas>
  <canvas id="durationChart" width="400" height="200"></canvas>
  <h2>History (last 20 runs)</h2>
  <div class="export-controls">
    <button id="export-csv">Export CSV</button>
    <button id="export-json">Export JSON</button>
  </div>
  <div class="filter-controls">
    <label>Status:
      <select id="filter-status">
        <option value="">All</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
        <option value="running">Running</option>
        <option value="pending">Pending</option>
      </select>
    </label>
    <label>Model:
      <select id="filter-model">
        <option value="">All</option>
      </select>
    </label>
    <label>ID:
      <input type="text" id="filter-id" placeholder="Search by ID..." />
    </label>
    <label>From:
      <input type="datetime-local" id="filter-from" />
    </label>
    <label>To:
      <input type="datetime-local" id="filter-to" />
    </label>
  </div>
  <table id="history-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Status</th>
        <th>Model</th>
        <th>Duration (ms)</th>
        <th>End Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="modal-bg" class="modal-bg" style="display:none;">
    <div class="modal">
      <button class="modal-close" id="modal-close">&times;</button>
      <button id="modal-download-json" style="position:absolute;top:0.5em;left:0.5em;">Download JSON</button>
      <div id="modal-content"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let allHistory = [];
    let filterStatus = '';
    let filterModel = '';
    let filterId = '';
    let filterFrom = '';
    let filterTo = '';
    let debounceTimer;
    let currentModalRun = null;
    function renderAgents(agents) {
      const tbody = document.querySelector('#agents-table tbody');
      tbody.innerHTML = '';
      for (const agent of agents) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${agent.id}</td>
          <td class="status-${agent.status}">${agent.status}</td>
          <td>${agent.selectedModel || ''}</td>
          <td>${agent.duration || ''}</td>
          <td>${agent.plan ? agent.plan.join('<br>') : ''}</td>
          <td>${agent.answer || ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }
    function renderAnalytics(analytics) {
      document.getElementById('analytics').innerHTML = `
        <b>Total:</b> ${analytics.total} &nbsp; 
        <b>Completed:</b> ${analytics.completed} &nbsp; 
        <b>Failed:</b> ${analytics.failed} &nbsp; <br>
        <b>Avg Duration:</b> ${analytics.avgDuration}ms &nbsp; 
        <b>Min:</b> ${analytics.minDuration}ms &nbsp; 
        <b>Max:</b> ${analytics.maxDuration}ms <br>
        <b>Model Usage:</b> ${Object.entries(analytics.modelUsage).map(([k,v]) => `${k}: ${v}`).join(', ')}
      `;
    }
    function renderHistory(history) {
      const tbody = document.querySelector('#history-table tbody');
      tbody.innerHTML = '';
      for (const run of history.slice(-20).reverse()) {
        const tr = document.createElement('tr');
        const endTime = run.endTime ? new Date(run.endTime).toLocaleString() : '';
        tr.innerHTML = `
          <td>${run.id}</td>
          <td class="status-${run.status}">${run.status}</td>
          <td>${run.selectedModel || ''}</td>
          <td>${run.duration || ''}</td>
          <td>${endTime}</td>
        `;
        tr.style.cursor = 'pointer';
        tr.addEventListener('click', () => showModal(run));
        tbody.appendChild(tr);
      }
    }
    function showModal(run) {
      currentModalRun = run;
      const modalBg = document.getElementById('modal-bg');
      const modalContent = document.getElementById('modal-content');
      let html = `<h3>Run ID: ${run.id}</h3>`;
      html += `<b>Status:</b> <span class="status-${run.status}">${run.status}</span><br>`;
      html += `<b>Model:</b> ${run.selectedModel || ''}<br>`;
      html += `<b>Duration:</b> ${run.duration || ''} ms<br>`;
      html += `<b>End Time:</b> ${run.endTime ? new Date(run.endTime).toLocaleString() : ''}<br>`;
      if (run.plan) html += `<b>Plan:</b><pre>${Array.isArray(run.plan) ? run.plan.join('\n') : run.plan}</pre>`;
      if (run.answer) html += `<b>Answer:</b><pre>${run.answer}</pre>`;
      if (run.error) html += `<b>Error:</b><pre>${run.error}</pre>`;
      if (run.logs) html += `<b>Logs:</b><pre>${Array.isArray(run.logs) ? run.logs.join('\n') : run.logs}</pre>`;
      // Show all other fields
      for (const k of Object.keys(run)) {
        if (["id","status","selectedModel","duration","endTime","plan","answer","error","logs"].includes(k)) continue;
        html += `<b>${k}:</b> <pre>${JSON.stringify(run[k], null, 2)}</pre>`;
      }
      modalContent.innerHTML = html;
      modalBg.style.display = 'flex';
    }
    document.getElementById('modal-close').onclick = () => {
      document.getElementById('modal-bg').style.display = 'none';
    };
    document.getElementById('modal-bg').onclick = (e) => {
      if (e.target === document.getElementById('modal-bg')) {
        document.getElementById('modal-bg').style.display = 'none';
      }
    };
    document.getElementById('modal-download-json').onclick = function() {
      if (!currentModalRun) return;
      const json = JSON.stringify(currentModalRun, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `agent-run-${currentModalRun.id}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };
    function updateUI(data) {
      renderAgents(data.agents);
      renderAnalytics(data.analytics);
    }
    // WebSocket support
    let ws;
    function connectWS() {
      ws = new WebSocket(`ws://${location.hostname}:3001`);
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          updateUI(data);
        } catch {}
      };
      ws.onerror = () => {
        ws.close();
      };
      ws.onclose = () => {
        // fallback to polling if ws closes
        setTimeout(startPolling, 2000);
      };
    }
    function startPolling() {
      async function poll() {
        try {
          const [agents, analytics] = await Promise.all([
            fetch('/agents').then(r => r.json()),
            fetch('/analytics').then(r => r.json())
          ]);
          updateUI({ agents, analytics });
        } catch {}
        setTimeout(poll, 2000);
      }
      poll();
    }
    async function updateHistory() {
      try {
        const history = await fetch('/history').then(r => r.json());
        allHistory = history;
        updateHistoryTable();
        updateModelFilterOptions();
      } catch {}
      setTimeout(updateHistory, 5000);
    }
    let filteredHistory = [];
    function updateCharts() {
      // Status Distribution
      const statusCounts = {};
      for (const run of filteredHistory) {
        statusCounts[run.status] = (statusCounts[run.status] || 0) + 1;
      }
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      if (window.statusChartObj) window.statusChartObj.destroy();
      window.statusChartObj = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: ['#2ecc40', '#ff4136', '#ff851b', '#aaaaaa'],
          }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
      // Model Usage
      const modelCounts = {};
      for (const run of filteredHistory) {
        if (run.selectedModel) modelCounts[run.selectedModel] = (modelCounts[run.selectedModel] || 0) + 1;
      }
      const modelCtx = document.getElementById('modelChart').getContext('2d');
      if (window.modelChartObj) window.modelChartObj.destroy();
      window.modelChartObj = new Chart(modelCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(modelCounts),
          datasets: [{
            label: 'Runs',
            data: Object.values(modelCounts),
            backgroundColor: '#0074d9',
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
      // Task Durations Over Time
      const sorted = filteredHistory.slice().sort((a, b) => (a.endTime || 0) - (b.endTime || 0));
      const durationCtx = document.getElementById('durationChart').getContext('2d');
      if (window.durationChartObj) window.durationChartObj.destroy();
      window.durationChartObj = new Chart(durationCtx, {
        type: 'line',
        data: {
          labels: sorted.map(r => r.endTime ? new Date(r.endTime).toLocaleString() : ''),
          datasets: [{
            label: 'Duration (ms)',
            data: sorted.map(r => r.duration || 0),
            borderColor: '#ff4136',
            backgroundColor: 'rgba(255,65,54,0.1)',
            fill: true,
            tension: 0.2,
          }]
        },
        options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { display: false } } }
      });
    }
    function updateHistoryTable() {
      let filtered = allHistory;
      if (filterStatus) filtered = filtered.filter(r => r.status === filterStatus);
      if (filterModel) filtered = filtered.filter(r => r.selectedModel === filterModel);
      if (filterId) filtered = filtered.filter(r => r.id.includes(filterId));
      if (filterFrom) {
        const fromTs = new Date(filterFrom).getTime();
        filtered = filtered.filter(r => r.endTime && new Date(r.endTime).getTime() >= fromTs);
      }
      if (filterTo) {
        const toTs = new Date(filterTo).getTime();
        filtered = filtered.filter(r => r.endTime && new Date(r.endTime).getTime() <= toTs);
      }
      filteredHistory = filtered;
      renderHistory(filtered);
      updateCharts();
    }
    function updateModelFilterOptions() {
      const select = document.getElementById('filter-model');
      const models = Array.from(new Set(allHistory.map(r => r.selectedModel).filter(Boolean)));
      const current = select.value;
      select.innerHTML = '<option value="">All</option>' + models.map(m => `<option value="${m}">${m}</option>`).join('');
      select.value = current;
    }
    document.getElementById('filter-status').addEventListener('change', function(e) {
      filterStatus = this.value;
      updateHistoryTable();
    });
    document.getElementById('filter-model').addEventListener('change', function(e) {
      filterModel = this.value;
      updateHistoryTable();
    });
    document.getElementById('filter-id').addEventListener('input', function(e) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        filterId = this.value.trim();
        updateHistoryTable();
      }, 200);
    });
    document.getElementById('filter-from').addEventListener('change', function() {
      filterFrom = this.value;
      updateHistoryTable();
    });
    document.getElementById('filter-to').addEventListener('change', function() {
      filterTo = this.value;
      updateHistoryTable();
    });
    document.getElementById('export-csv').addEventListener('click', async function() {
      try {
        if (!filteredHistory.length) return;
        const keys = Object.keys(filteredHistory[0]);
        const csv = [keys.join(',')].concat(filteredHistory.map(row => keys.map(k => JSON.stringify(row[k] ?? '')).join(','))).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'agent-history.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch {}
    });
    document.getElementById('export-json').addEventListener('click', function() {
      try {
        if (!filteredHistory.length) return;
        const json = JSON.stringify(filteredHistory, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'agent-history.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch {}
    });
    if ('WebSocket' in window) {
      connectWS();
    } else {
      startPolling();
    }
    updateHistory();
    // Initial chart render
    updateCharts();
  </script>
</body>
</html> 